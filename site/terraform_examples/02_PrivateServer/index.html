
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../01_SetUpS3Backend/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.6">
    
    
      
        <title>02 Create your server - AWS Infra Demos</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.ded33207.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#example-02-vpn-and-server-creation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="AWS Infra Demos" class="md-header__button md-logo" aria-label="AWS Infra Demos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AWS Infra Demos
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              02 Create your server
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="AWS Infra Demos" class="md-nav__button md-logo" aria-label="AWS Infra Demos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    AWS Infra Demos
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Bash Examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Bash Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bash_examples/01_retrieveAMIs/" class="md-nav__link">
        01 Getting AMIs
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Terraform Examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Terraform Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../01_SetUpS3Backend/" class="md-nav__link">
        01 Backend Setup
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          02 Create your server
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        02 Create your server
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pre-requisites" class="md-nav__link">
    Pre-requisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#frequent-questions" class="md-nav__link">
    Frequent Questions
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pre-requisites" class="md-nav__link">
    Pre-requisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#frequent-questions" class="md-nav__link">
    Frequent Questions
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="example-02-vpn-and-server-creation">Example 02: VPN and server creation<a class="headerlink" href="#example-02-vpn-and-server-creation" title="Permanent link">#</a></h1>
<p>In this example we are going to create a VPN and access it only from our current (public) IP address. This tutorial is inspired in the example provided <a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html#nacl-examples">by AWS in their official documentation</a>. This example also takes advantage of the guidance provided by <a href="https://medium.com/@aliatakan/terraform-create-a-vpc-subnets-and-more-6ef43f0bf4c1">Ali Atakan Medium article</a>.<br></p>
<p>This implementation makes use of Security Group that acts as a firewall filtering the incoming and outgoing traffic from instances within the subnet within the VPC. There's  a second way of doing this (in example 3) that uses ACL's. </p>
<h3 id="pre-requisites">Pre-requisites<a class="headerlink" href="#pre-requisites" title="Permanent link">#</a></h3>
<p><strong>SSH keys:</strong> As part of this example a server in EC2 will be created, and access to it through SSH will be granted from your public IP.  The default key pair will be <em>demo-e2-key</em> and demo-e2-key.pub. Which will be stored under <strong>/root/.ssh/</strong>.<br></p>
<p>You can use the following command to generate the key pair.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>ssh-keygen<span class="w"> </span>-f<span class="w"> </span>/root/.ssh/demo-e2-key
</code></pre></div>
<p>Then you can use the following command to connect via SSH once the server is up:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>ssh<span class="w"> </span>-i<span class="w"> </span>ireland-region-key-pair<span class="w"> </span>ubuntu@ec2-34-243-2-176.eu-west-1.compute.amazonaws.com
</code></pre></div>
<!-- 
### Installation steps ###

0. Declare the variables that you are going to use in this example in the **variables.tf** file: 
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nx">variable</span><span class="w"> </span><span class="s">&quot;aws_region&quot;</span><span class="w"> </span><span class="p">{</span><span class="w">    </span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;eu-west-1&quot;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="nx">description</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;The region of the AWS account&quot;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="p">}</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="nx">variable</span><span class="w"> </span><span class="s">&quot;secure_public_ip_address&quot;</span><span class="w"> </span><span class="p">{</span><span class="w">    </span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="nx">description</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;The ip address (IPv4) that can access the instance&quot;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="p">}</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="nx">variable</span><span class="w"> </span><span class="s">&quot;ami&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">map</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">        </span><span class="s">&quot;eu-west-1&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ami-09b9e380df60300c8&quot;</span><span class="p">,</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">        </span><span class="s">&quot;eu-west-2&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ami-03dea29b0216a1e03&quot;</span><span class="p">,</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">        </span><span class="s">&quot;us-east-1&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ami-0c2a1acae6667e438&quot;</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="p">}</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="nx">variable</span><span class="w"> </span><span class="s">&quot;private_key_path&quot;</span><span class="w"> </span><span class="p">{</span><span class="w">    </span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">    </span><span class="nx">description</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Path to the private Key of the SSH.&quot;</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ireland-region-key-pair&quot;</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="p">}</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="nx">variable</span><span class="w"> </span><span class="s">&quot;public_key_path&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">  </span><span class="k">default</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ireland-region-key-pair.pub&quot;</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="p">}</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="nx">variable</span><span class="w"> </span><span class="s">&quot;ec2_user&quot;</span><span class="w"> </span><span class="p">{</span><span class="w">    </span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="w">    </span><span class="nx">description</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;EC2 User.&quot;</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ubuntu&quot;</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="p">}</span>
</code></pre></div>

1. Define the providers used for this example in the **providers.tf** file:

<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nx">provider</span><span class="w"> </span><span class="s">&quot;aws&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="nx">region</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">var</span><span class="p">.</span><span class="nx">aws_region</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="nx">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;~&gt; 3.14.1&quot;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="p">}</span>
</code></pre></div>


2. Create the VPC and the Subnet in the file **vpc.tf**:

<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nx">resource</span><span class="w"> </span><span class="s">&quot;aws_vpc&quot;</span><span class="w"> </span><span class="s">&quot;prod-vpc&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="nx">cidr_block</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;10.0.0.0/16&quot;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="nx">enable_dns_support</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="err">#</span><span class="nx">gives</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">internal</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">name</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="nx">enable_dns_hostnames</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="err">#</span><span class="nx">gives</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">internal</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="nx">name</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="nx">enable_classiclink</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="nx">instance_tenancy</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="w">    </span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span><span class="nx">tags</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">        </span><span class="s">&quot;Name&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;prod-vpc&quot;</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="p">}</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="nx">resource</span><span class="w"> </span><span class="s">&quot;aws_subnet&quot;</span><span class="w"> </span><span class="s">&quot;prod-subnet-public-1&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">    </span><span class="nx">vpc_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">prod</span><span class="o">-</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">    </span><span class="nx">cidr_block</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;10.0.1.0/24&quot;</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">    </span><span class="nx">map_public_ip_on_launch</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="c1">//it makes this a public subnet</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">    </span><span class="nx">availability_zone</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;eu-west-1a&quot;</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">    </span><span class="nx">tags</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">        </span><span class="s">&quot;Name&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;prod-subnet-public-1&quot;</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="p">}</span>
</code></pre></div>

3. In the file **network.tf**: Create the Internet Gateway that will allow the VPC to connect to the internet, define the IP addresses that the VPC can access/be accessed with through the Custom Route Table and associate it with the Subnet created before. Lastly define the Security Group that will act as the firewall of the instance.
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="err">#</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">IGW</span><span class="w"> </span><span class="p">(</span><span class="nx">Internet</span><span class="w"> </span><span class="nx">Gateway</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="err">#</span><span class="w"> </span><span class="nx">It</span><span class="w"> </span><span class="nx">enables</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">vpc</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">connect</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">internet</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nx">resource</span><span class="w"> </span><span class="s">&quot;aws_internet_gateway&quot;</span><span class="w"> </span><span class="s">&quot;prod-igw&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">Internet</span><span class="w"> </span><span class="nx">Gateway</span><span class="w"> </span><span class="p">(</span><span class="nx">IGW</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="nx">vpc_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">prod</span><span class="o">-</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="nx">tags</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">        </span><span class="s">&quot;Name&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;prod-igw&quot;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="p">}</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="err">#</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">custom</span><span class="w"> </span><span class="nx">route</span><span class="w"> </span><span class="nx">table</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">public</span><span class="w"> </span><span class="nx">subnets</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="err">#</span><span class="w"> </span><span class="nx">public</span><span class="w"> </span><span class="nx">subnets</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">reach</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">internet</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">this</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="nx">resource</span><span class="w"> </span><span class="s">&quot;aws_route_table&quot;</span><span class="w"> </span><span class="s">&quot;prod-public-crt&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">#</span><span class="nx">Custom</span><span class="w"> </span><span class="nx">Route</span><span class="w"> </span><span class="nx">Table</span><span class="w"> </span><span class="p">(</span><span class="nx">CRT</span><span class="p">)</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">    </span><span class="nx">vpc_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">prod</span><span class="o">-</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">    </span><span class="nx">route</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">        </span><span class="c1">//associated subnet can reach everywhere</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">        </span><span class="nx">cidr_block</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;0.0.0.0/0&quot;</span><span class="w"> </span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">        </span><span class="c1">//CRT uses this IGW to reach internet</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">        </span><span class="nx">gateway_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">aws_internet_gateway</span><span class="p">.</span><span class="nx">prod</span><span class="o">-</span><span class="nx">igw</span><span class="p">.</span><span class="nx">id</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="w">    </span><span class="nx">tags</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="w">        </span><span class="s">&quot;Name&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;prod-public-crt&quot;</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="p">}</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="err">#</span><span class="w"> </span><span class="nx">route</span><span class="w"> </span><span class="nx">table</span><span class="w"> </span><span class="nx">association</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">public</span><span class="w"> </span><span class="nx">subnets</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="nx">resource</span><span class="w"> </span><span class="s">&quot;aws_route_table_association&quot;</span><span class="w"> </span><span class="s">&quot;prod-crta-public-subnet-1&quot;</span><span class="p">{</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="w">    </span><span class="nx">subnet_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">aws_subnet</span><span class="p">.</span><span class="nx">prod</span><span class="o">-</span><span class="nx">subnet</span><span class="o">-</span><span class="nx">public</span><span class="o">-</span><span class="m">1.i</span><span class="nx">d</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a><span class="w">    </span><span class="nx">route_table_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">aws_route_table</span><span class="p">.</span><span class="nx">prod</span><span class="o">-</span><span class="nx">public</span><span class="o">-</span><span class="nx">crt</span><span class="p">.</span><span class="nx">id</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="p">}</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a><span class="err">#</span><span class="w"> </span><span class="nx">security</span><span class="w"> </span><span class="nx">group</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a><span class="nx">resource</span><span class="w"> </span><span class="s">&quot;aws_security_group&quot;</span><span class="w"> </span><span class="s">&quot;ssh-allowed&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a><span class="w">    </span><span class="nx">vpc_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">prod</span><span class="o">-</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">id</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a><span class="w">    </span><span class="nx">egress</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a><span class="w">        </span><span class="nx">from_port</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a><span class="w">        </span><span class="nx">to_port</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a><span class="w">        </span><span class="nx">protocol</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a><span class="w">        </span><span class="nx">cidr_blocks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;0.0.0.0/0&quot;</span><span class="p">]</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">The</span><span class="w"> </span><span class="nx">instance</span><span class="w"> </span><span class="nx">needs</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">able</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">outgoing</span><span class="w"> </span><span class="nx">traffic</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">everywhere</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">collect</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">NGINX</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">EC2</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a><span class="w">    </span><span class="nx">ingress</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a><span class="w">        </span><span class="nx">from_port</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">22</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a><span class="w">        </span><span class="nx">to_port</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">22</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a><span class="w">        </span><span class="nx">protocol</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tcp&quot;</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a><span class="w">        </span><span class="nx">cidr_blocks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;${var.secure_public_ip_address}/32&quot;</span><span class="p">]</span><span class="w"> </span><span class="err">#</span><span class="p">[</span><span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">prod</span><span class="o">-</span><span class="nx">vpc</span><span class="p">.</span><span class="nx">cidr_block</span><span class="p">]</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a><span class="w">    </span><span class="c1">//If you do not add this rule, you can not reach the NGIX  </span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a><span class="w">    </span><span class="nx">ingress</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a><span class="w">        </span><span class="nx">from_port</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">80</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a><span class="w">        </span><span class="nx">to_port</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">80</span>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a><span class="w">        </span><span class="nx">protocol</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tcp&quot;</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a><span class="w">        </span><span class="nx">cidr_blocks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;${var.secure_public_ip_address}/32&quot;</span><span class="p">]</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a><span class="w">    </span><span class="nx">tags</span><span class="w"> </span><span class="p">=</span><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a><span class="w">        </span><span class="s">&quot;Name&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ssh-allowed&quot;</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a><span class="p">}</span>
</code></pre></div>

5.  In the **ec2.tf** define the EC2 as belonging in the previously defined subnet and associate with it the previously defined security group (firewall). Also associate a SSH key with it (to be created in the next step), and indicate to the instance that it needs to execute the file **nginx.sh** when instantiated, this file will install and trigger the NGINX server.

<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nx">resource</span><span class="w"> </span><span class="s">&quot;aws_instance&quot;</span><span class="w"> </span><span class="s">&quot;web1&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="nx">ami</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">lookup</span><span class="p">(</span><span class="kd">var</span><span class="p">.</span><span class="nx">ami</span><span class="p">,</span><span class="w"> </span><span class="kd">var</span><span class="p">.</span><span class="nx">aws_region</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="nx">instance_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;t2.micro&quot;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nx">VPC</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="nx">subnet_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">aws_subnet</span><span class="p">.</span><span class="nx">prod</span><span class="o">-</span><span class="nx">subnet</span><span class="o">-</span><span class="nx">public</span><span class="o">-</span><span class="m">1.i</span><span class="nx">d</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nx">Security</span><span class="w"> </span><span class="nx">Group</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span><span class="nx">vpc_security_group_ids</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="nx">aws_security_group</span><span class="p">.</span><span class="nx">ssh</span><span class="o">-</span><span class="nx">allowed</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">Public</span><span class="w"> </span><span class="nx">SSH</span><span class="w"> </span><span class="nx">key</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="nx">key_name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">aws_key_pair</span><span class="p">.</span><span class="nx">ireland</span><span class="o">-</span><span class="nx">region</span><span class="o">-</span><span class="nx">key</span><span class="o">-</span><span class="nx">pair</span><span class="p">.</span><span class="nx">id</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nx">nginx</span><span class="w"> </span><span class="nx">installation</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">    </span><span class="nx">provisioner</span><span class="w"> </span><span class="s">&quot;file&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">        </span><span class="nx">source</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;nginx.sh&quot;</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">        </span><span class="nx">destination</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;/tmp/nginx.sh&quot;</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">    </span><span class="nx">provisioner</span><span class="w"> </span><span class="s">&quot;remote-exec&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">        </span><span class="nx">inline</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">             </span><span class="s">&quot;chmod +x /tmp/nginx.sh&quot;</span><span class="p">,</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">             </span><span class="s">&quot;sudo /tmp/nginx.sh&quot;</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">        </span><span class="p">]</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">    </span><span class="nx">connection</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">        </span><span class="nx">host</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">self</span><span class="p">.</span><span class="nx">public_ip</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">        </span><span class="nx">user</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">var</span><span class="p">.</span><span class="nx">ec2_user</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w">        </span><span class="nx">private_key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">file</span><span class="p">(</span><span class="kd">var</span><span class="p">.</span><span class="nx">private_key_path</span><span class="p">)</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="p">}</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="c1">// Sends your public key to the instance</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="nx">resource</span><span class="w"> </span><span class="s">&quot;aws_key_pair&quot;</span><span class="w"> </span><span class="s">&quot;ireland-region-key-pair&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="w">    </span><span class="nx">key_name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ireland-region-key-pair&quot;</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="w">    </span><span class="nx">public_key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">file</span><span class="p">(</span><span class="kd">var</span><span class="p">.</span><span class="nx">public_key_path</span><span class="p">)</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="p">}</span>
</code></pre></div>

However looking deeper two **provisioner** resources are being used. <br>

First the **file** provisioner is used to copy files or directories from the machine executing Terraform to the newly created resource, the file provisioner supports both ssh and winrm type connections.<br>

Secondly the **remote-exec** provisioner invokes a script on a remote resource after it is created ([Terraform Docs](https://www.terraform.io/docs/language/resources/provisioners/remote-exec.html)). Which in this case is used to change the **nginx.sh** file making it executable and immediately after execute it, triggerring the installation of NGINX server in the ec2 instance.<br>

For the provider to connect to the EC2 instance and run the script we need to provide it with a connection block (either for all provisioners, if nested within the resource, or to a specific provisioner if decalred within the provisioner, [Terraform Docs](https://www.terraform.io/docs/language/resources/provisioners/connection.html)).
-  **host** - (Required) The address of the resource to connect to.(For example, use self.public_ip to reference an aws_instance's public_ip attribute)
-  **user** - The user that we should use for the connection.
-  **private_key** - The contents of an SSH key to use for the connection. These can be loaded from a file on disk using the file function. 

6. Congrats! The Terraform code is all done, however we need to generate the keypair to be able to SSH into the EC2 instance which can be done with following CLI command. 

<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="ch">#!/usr/bin/env bash</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>ssh-keygen<span class="w"> </span>-f<span class="w"> </span>ireland-region-key-pair
</code></pre></div>
And also you need to create a file called **nginx.sh** that contains the command to install the NGINX server in the EC2 instance and initialize it once started. The loading/installation of a program through another program is usually called bootstrapping. 

<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1"># sleep until instance is ready</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="k">until</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span>/var/lib/cloud/instance/boot-finished<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span>sleep<span class="w"> </span><span class="m">1</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="k">done</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="c1"># install nginx</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>root-system-bin
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>sudo<span class="w"> </span>apt-get<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>nginx
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="c1"># make sure nginx is started</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>sudo<span class="w"> </span>service<span class="w"> </span>nginx<span class="w"> </span>start
</code></pre></div>

7. All that remains to do before running terraform is to create the **variables.tfvar** file defining your particular zone and public IP address.

<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nx">aws_region</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;eu-west-1&quot;</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="nx">secure_public_ip_address</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;1.2.3.4&quot;</span>
</code></pre></div>

8.  is all done now, feel free to

<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>terraform<span class="w"> </span>init
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>terraform<span class="w"> </span>apply<span class="w"> </span>-var-file<span class="o">=</span>variables.tfvars
</code></pre></div>

### Rants: ###
**Security Groups vs Access Control Lists (ACL)**<br>
Security group is the firewall of EC2 Instances whereas Network ACL is the firewall of the Subnet.

- ACL works like a global firewall for the VPC
- Security groups works like a firewalls for the instances

### On Security Groups ###

**Security group rules**<br>

- A rule applies either to inbound traffic (**ingress**) or outbound traffic (**egress**). 


**What do I put in the CIDR block?** <br>
Well well well, what you need to do is to put your public IP address followed by a "/" slash 32. This is because of the notation used for CIDR, where you indicate how many bits are used to identify the network protion of the address. For more info look into [This WEBSITE](https://docs.netgate.com/pfsense/en/latest/network/cidr.html) and [This WEBSITE](https://docs.netgate.com/pfsense/en/latest/network/cidr.html).


### Implementation Notes ###

The **nginx.sh** file contains the set of commands that the EC2 instance is going to run once created, basically it will fetch the libraries needed to install the nginx server and run it. An important factor to consider is that if you are using Windows the End of Line (EOF) character is different and you will need to change it to the Linux type. Otherwise you are going to see errors like this after the **terraform apply** command:<br>

<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>aws_instance.web1:<span class="w"> </span>Still<span class="w"> </span>creating...<span class="w"> </span><span class="o">[</span>40s<span class="w"> </span>elapsed<span class="o">]</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>aws_instance.web1<span class="w"> </span><span class="o">(</span>remote-exec<span class="o">)</span>:<span class="w"> </span>/tmp/nginx.sh:<span class="w"> </span><span class="m">1</span>:<span class="w"> </span>/tmp/nginx.sh:
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>aws_instance.web1<span class="w"> </span><span class="o">(</span>remote-exec<span class="o">)</span>:<span class="w"> </span>:<span class="w"> </span>not<span class="w"> </span>found
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>aws_instance.web1<span class="w"> </span><span class="o">(</span>remote-exec<span class="o">)</span>:<span class="w"> </span>/tmp/nginx.sh:<span class="w"> </span><span class="m">3</span>:<span class="w"> </span>/tmp/nginx.sh:
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>aws_instance.web1<span class="w"> </span><span class="o">(</span>remote-exec<span class="o">)</span>:<span class="w"> </span>:<span class="w"> </span>not<span class="w"> </span>found
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>aws_instance.web1<span class="w"> </span><span class="o">(</span>remote-exec<span class="o">)</span>:<span class="w"> </span>/tmp/nginx.sh:<span class="w"> </span><span class="m">19</span>:<span class="w"> </span>/tmp/nginx.sh:<span class="w"> </span>Syntax<span class="w"> </span>error:<span class="w"> </span>end<span class="w"> </span>of<span class="w"> </span>file<span class="w"> </span>unexpected<span class="w"> </span><span class="o">(</span>expecting<span class="w"> </span><span class="s2">&quot;do&quot;</span><span class="o">)</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>Error:<span class="w"> </span>error<span class="w"> </span>executing<span class="w"> </span><span class="s2">&quot;/tmp/terraform_1180621267.sh&quot;</span>:<span class="w"> </span>Process<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span>status<span class="w"> </span><span class="m">2</span>
</code></pre></div>

Alternatively you can SSH directly into the instance using:
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>ssh<span class="w"> </span>-i<span class="w"> </span>ireland-region-key-pair<span class="w"> </span>ubuntu@ec2-3-250-18-225.eu-west-1.compute.amazonaws.com
</code></pre></div>

And install the nginx server manually. 

**Make sure that whenn using Terraform you are using your IP address in the whitelisting rules, otherwise the terraform apply command won't be able to provide the file nginx.sh to the EC2 instance.** -->

<h3 id="frequent-questions">Frequent Questions<a class="headerlink" href="#frequent-questions" title="Permanent link">#</a></h3>
<p><strong>How do you know your public IP address?</strong><br>
However as you may already know if your internet provider allocates you a dynamic IP address, your public IP address is going to change everytime you turn on and off your PC. Therefore the first thing to address in this document is how to retrieve your public IP address thing you need to do is to know what your. <br></p>
<p>There are many ways to get your public IP address:
1. From Bash Script: As in this  <a href="https://unix.stackexchange.com/questions/22615/how-can-i-get-my-external-ip-address-in-a-shell-script">StackExchange article</a>, using the <strong>dig</strong> command working with <a href="https://en.wikipedia.org/wiki/OpenDNS">OpenDNS</a>.<br>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>dig<span class="w"> </span>+short<span class="w"> </span>myip.opendns.com<span class="w"> </span>@resolver1.opendns.com
</code></pre></div>
2. From using your brower and going to <a href="http://ipv4.icanhazip.com">http://ipv4.icanhazip.com</a>. Note that if you are using a VPN this value may change.</p>
<p>In this example we do not care about the passing it as an input because the IP address is fetched using
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nx">data</span><span class="w"> </span><span class="s">&quot;http&quot;</span><span class="w"> </span><span class="s">&quot;myip&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">  </span><span class="nx">url</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;http://ipv4.icanhazip.com&quot;</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="p">}</span>
</code></pre></div></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.51198bba.min.js"></script>
      
        <script src="../../src_docs/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>